{"version":3,"sources":["assets\\Script\\framewrok\\UIViewControl.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["import SimpleDictionary from \"./utils/SimpleDictionary\";\r\nimport MsgCallUtils from \"./utils/MsgCallUtils\";\r\nimport GameEvent from \"../game/data/GameEvent\";\r\nimport UIViewInfo from \"./UIViewInfo\";\r\nimport ArrayUtil from \"./utils/ArrayUtil\";\r\n\r\n//定义UIView视图数据格式\r\nexport enum UIViewType {\r\n    none  = 0,\r\n    main  = 1,\r\n    popup = 2\r\n}\r\n\r\nexport default class UIViewControl\r\n{\r\n    private static _instance:UIViewControl;\r\n    \r\n    private loadingDic:SimpleDictionary;//UIView加载数据字典\r\n    private openViewDic:SimpleDictionary;//已经打开的UIView\r\n    private closeCacheViewDic:SimpleDictionary;//已经关闭但缓存了的UIView\r\n    \r\n    private alphaBack:cc.Node = null;//通用遮罩背景\r\n    public hasSetup:boolean = false;\r\n    public baseZIndex:number = 10;//设置默认zInde\r\n\r\n    public static get instance():UIViewControl\r\n    {\r\n        if(this._instance == null)\r\n        {\r\n            this._instance = new UIViewControl();\r\n        }\r\n        return this._instance;\r\n    }\r\n\r\n    public setup():void\r\n    {\r\n        this.loadingDic = new SimpleDictionary();\r\n        this.openViewDic = new SimpleDictionary(); \r\n        this.closeCacheViewDic = new SimpleDictionary(); \r\n        MsgCallUtils.addObserver(GameEvent.SHOW_UIVIEW,this,this.showUIView);\r\n        MsgCallUtils.addObserver(GameEvent.CLOSE_UIVIEW,this,this.closeUIView);\r\n        this.hasSetup   = true;\r\n    }\r\n\r\n    showViewTween(node, isPopup, callBack) {\r\n        if (node == null) {\r\n            return\r\n        }\r\n        if (isPopup == true) {\r\n            node.opacity = 0;\r\n            node.setScale(0.1);\r\n            let fadeIn = cc.fadeIn(0.2);\r\n            let scaleTo = cc.scaleTo(0.2, 1);\r\n            cc.tween(node).\r\n            then(fadeIn).\r\n            then(scaleTo).\r\n            call(function () {\r\n                if (callBack) callBack();\r\n            }.bind(node)).start();\r\n        }\r\n        else {\r\n            node.opacity = 1;\r\n            node.setScale(1);\r\n            let fadeOut = cc.fadeOut(0.2);\r\n            let scaleTo = cc.scaleTo(0.2, 0.1);\r\n            cc.tween(node).\r\n            then(fadeOut).\r\n            then(scaleTo).\r\n            call(function () {\r\n                if (callBack) callBack();\r\n            }.bind(node)).start();\r\n        }\r\n    }\r\n\r\n    //调用界面关闭\r\n    private closeUIView(msg:string,obj:any):void\r\n    {\r\n        if(!this.hasSetup)\r\n        {\r\n            cc.log(\"UIViewControl has not setup\")\r\n            return;\r\n        }\r\n        let url  = obj as string;\r\n        let uiInfo = this.openViewDic.getItem(url);\r\n        if(uiInfo == null)return;\r\n        this.openViewDic.deleteItem(uiInfo.url);\r\n        this.showViewTween(uiInfo.view,false,function()\r\n        {\r\n            if(uiInfo.isCache)\r\n            {\r\n                this.closeCacheViewDic.addItem(uiInfo.url,uiInfo);\r\n                uiInfo.view.parent = null;\r\n                if(uiInfo.alphaBackNode)uiInfo.alphaBackNode.parent = null;\r\n            }\r\n            else\r\n            {\r\n                uiInfo.dispose();\r\n            }\r\n        }.bind(this));\r\n        this.refreshViewIndex();\r\n    }\r\n\r\n    //外部派发事件，传递对应UIView参数即可打开界面\r\n    private showUIView(msg:string,obj:any):void\r\n    {\r\n        if(!this.hasSetup)\r\n        {\r\n            cc.log(\"UIViewControl has not setup\")\r\n            return;\r\n        }\r\n        let uiInfo = obj as UIViewInfo;\r\n        if(uiInfo == null)return;\r\n        let canvas = cc.director.getScene().getChildByName('Canvas');\r\n        if(this.openViewDic.getItem(uiInfo.url))//已经打开了，则重新设置zIndex\r\n        {\r\n            uiInfo = this.openViewDic.getItem(uiInfo.url)\r\n            uiInfo.zIndex = this.getViewIndex();\r\n            this.refreshViewIndex();\r\n        }\r\n        else\r\n        {\r\n            if(this.closeCacheViewDic.getItem(uiInfo.url))//处于缓存关闭状态，移除缓存，添加到打开列表\r\n            {\r\n                uiInfo = this.closeCacheViewDic.getItem(uiInfo.url)\r\n                this.closeCacheViewDic.deleteItem(uiInfo.url);\r\n                this.openViewDic.addItem(uiInfo.url,uiInfo);         \r\n                this.resetView(uiInfo);\r\n            }\r\n            else//请求加载\r\n            {\r\n                this.loadUIView(uiInfo,function(viewNode)\r\n                {\r\n                    if(!viewNode)\r\n                    {\r\n                        cc.log(\"prefab load error\");\r\n                        return;\r\n                    }\r\n                    //加载完成\r\n                    this.loadingDic.deleteItem(uiInfo.url);\r\n                    this.openViewDic.addItem(uiInfo.url,uiInfo);\r\n                    //添加到舞台\r\n                    uiInfo.view = viewNode;\r\n                    uiInfo.zIndex = this.getViewIndex();\r\n                    this.resetView(uiInfo);\r\n                    \r\n                }.bind(this));\r\n            }\r\n        }\r\n        \r\n    }\r\n\r\n    private resetView(uiInfo):void\r\n    {\r\n        uiInfo.zIndex = this.getViewIndex();\r\n        let canvas = cc.director.getScene().getChildByName('Canvas');\r\n        if(uiInfo.needAlphaBg && uiInfo.alphaBackNode)uiInfo.alphaBackNode.parent = canvas;\r\n        uiInfo.view.parent = canvas;\r\n        if(uiInfo.needTween)\r\n        {\r\n            this.showViewTween(uiInfo.view, true, function() \r\n            {\r\n                this.refreshViewIndex();\r\n            }.bind(this));  \r\n        }\r\n    }\r\n\r\n    //加载UI视图，loadPrefab\r\n    private loadUIView(uiInfo,callBack):void\r\n    {\r\n        let canvas = cc.director.getScene().getChildByName('Canvas');\r\n        if(this.loadingDic[uiInfo.url])//已经处于加载中了\r\n        {\r\n            // canvas.once(uiInfo.url, function (node) \r\n            // {\r\n            //     callBack(node);\r\n            // });\r\n            // return;\r\n        }\r\n        else\r\n        {\r\n            this.loadingDic.addItem(uiInfo.url,uiInfo);\r\n        }\r\n        cc.loader.loadRes(uiInfo.url, cc.Prefab, function (err, prefab) \r\n        {\r\n            if (!err) \r\n            {\r\n                this.loadingDic.deleteItem(uiInfo.url);\r\n                let node = cc.instantiate(prefab);\r\n                node.group = \"ui\";\r\n                callBack(node);\r\n            }\r\n            else\r\n            {\r\n                callBack(null);\r\n            }\r\n        }.bind(this));\r\n    }\r\n\r\n    private getViewIndex():number\r\n    {\r\n        let result:number = 0;\r\n        for (const key in this.openViewDic) {\r\n            let info = this.openViewDic.getItem(key);\r\n            if(!info)continue;\r\n            if(info.needAlphaBg && info.alphaBackNode)\r\n            {\r\n                result += 2;\r\n            }\r\n            else\r\n            {\r\n                result += 1;\r\n            }\r\n        }\r\n        return result;\r\n    }\r\n\r\n    public refreshViewIndex():void\r\n    {\r\n        let openAry = this.openViewDic.getValues();\r\n        openAry.sort(ArrayUtil.sortOn(\"zIndex\"));\r\n        let zIndex:number = -1;  \r\n        for (let index = 0; index < openAry.length; index++)\r\n        {\r\n            let info = openAry[index];\r\n            let node = info.view;\r\n            if(info.needAlphaBg && info.alphaBackNode)\r\n            {\r\n                zIndex += 2;\r\n                info.alphaBackNode.zIndex = zIndex - 1;\r\n                node.zIndex = zIndex;\r\n            }\r\n            else\r\n            {\r\n                zIndex += 1;\r\n                node.zIndex = zIndex;\r\n            }\r\n        }\r\n    }\r\n\r\n    public dispose()\r\n    {\r\n        this.hasSetup  = false;\r\n        this.loadingDic.clear();\r\n        this.openViewDic.clear();\r\n        this.closeCacheViewDic.clear();\r\n        MsgCallUtils.removeObserver(GameEvent.SHOW_UIVIEW,this,this.showUIView);\r\n        MsgCallUtils.removeObserver(GameEvent.CLOSE_UIVIEW,this,this.closeUIView);\r\n    }\r\n}\r\n"]}